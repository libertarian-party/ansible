Конфигурация Ansible
====================

Конфигурация верхнего уровня для развёртывания инфраструктуры базы данных
Либертарианской партии России с помощью [Ansible](https://www.ansible.com).



Содержание
----------

* [Обзор](#конфигурация-ansible)
* [Содержание](#содержание)
* [Именование серверов](#именование-серверов)
* [Подготовка серверов](#подготовка-серверов)
* [Подготовка конфигурации](#подготовка-конфигурации)
* [Использование конфигурации](#использование-конфигурации)



Именование серверов
-------------------

Идентификация серверов производится с помощью `A` и `AAAA` записей DNS.
В качестве имён используются английские наименования греческих букв, например:

* `alpha.libertarian-party.com`
* `beta.libertarian-party.com`
* `gamma.libertarian-party.com`
* `delta.libertarian-party.com`

Для именования логических доменных имён используются `CNAME` записи DNS,
которые указывают на один из идентификаторов серверов:

* `www.libertarian-party.com` -> `alpha.libertarian-party.com`
* `stg.libertarian-party.com` -> `delta.libertarian-party.com`

Единственное логическое доменное имя, которое не использует `CNAME` записи DNS -
это `@` (например, `libertarian-party.com`), потому что это технически
невозможно. Для этого доменного имени используйте `A` и `AAAA` записи DNS,
дублирующие соответствующий идентификатор сервера
(например, `alpha.libertarian-party.com`).



Подготовка серверов
-------------------

Необходимо создать на серверах пользователя, добавить его в группу `sudo`,
установить ему пароль и записать его в инвентарь конфигурации. Это можно
сделать, выполнив указанные далее команды на сервере. Имя пользователя
`kotovalexarian` замените на ваше.

```
adduser --gecos '' kotovalexarian
usermod -a -G sudo kotovalexarian
```

Также нужно будет разрешить этому пользователю подключаться по SSH с помощью
вашего публичного ключа. Текущая конфигурация отключает возможность
аутентификации по паролю. Убедитесь, что вы можете войти с помощью публичного
ключа, иначе вы рискуете потерять доступ к серверу.



Подготовка конфигурации
-----------------------

Для ускорения работы Ansible используется библиотека
[Mitogen](https://mitogen.networkgenomics.com/). Необходимо установить её
в директорию `vendor`:

```
wget -O vendor/mitogen-0.2.8.tar.gz https://networkgenomics.com/try/mitogen-0.2.8.tar.gz
tar -xzf vendor/mitogen-0.2.8.tar.gz -C vendor/
```

Конфигурация зависит от ролей [Ansible Galaxy](https://galaxy.ansible.com),
указанных в файле `requirements.yml`. Следующую команду нужно запускать
перед началом работы с конфигурацией, а также после добавления ролей
или изменения их версий:

```
ansible-galaxy install -r requirements.yml -f
```



Использование конфигурации
--------------------------

Примеры команд даны для среды `production`. Для выполнения команд для среды
`staging` замените `-i inventories/production/` на `-i inventories/staging/`.
Можно опустить этот аргумент, по умолчанию используется среда `production`.

Перезагрузка всех серверов:

```
ansible all -i inventories/production/ -m reboot
```

Обновление системных пакетов на всех серверах:

```
ansible all -i inventories/production/ -m apt -a 'update_cache=yes upgrade=yes'
```

Показать пароль пользователя для каждого сервера:

```
ansible all -i inventories/production/ -m debug -a "msg='{{ ansible_become_pass }}'"
```

Развёртывание всей инфраструктуры:

```
ansible-playbook -i inventories/production/ playbooks/site.yml
```
